# CLAUDE.md

This file provides guidance to AI agents when working with code.

## Backend Stack

Altinn Studio Designer's backend is built using the following technologies:

- .NET 9.0 (ASP.NET Core Web API)
- Entity Framework Core with PostgreSQL
- SignalR for real-time communication
- MediatR for CQRS/mediator pattern
- Kafka for event streaming and integration
- Redis for caching and SignalR backplane
- Quartz for background job scheduling
- LibGit2Sharp for Git repository operations
- xUnit with Moq for unit testing
- Testcontainers for integration testing
- Docker support for containerization

## Project Structure

The backend consists of three main projects in a Visual Studio solution:

### Core Projects

- **`src/Designer/`** - Main ASP.NET Core Web API application containing:
    - `Controllers/` - API endpoints organized by feature area
    - `Services/` - Business logic and domain services
    - `Models/` - Data models, DTOs, and domain objects
    - `Infrastructure/` - Cross-cutting concerns (auth, git, configuration)
    - `EventHandlers/` - MediatR event handlers for domain events
    - `Hubs/` - SignalR hubs for real-time communication
    - `Migrations/` - Entity Framework database migrations
    - `Scheduling/` - Quartz background job definitions

- **`src/DataModeling/`** - Data modeling and schema conversion library:
    - `Converter/` - Converts between JSON Schema, XSD, and C# models
    - `Json/` - JSON Schema processing and validation
    - `Metamodel/` - Internal data model representation
    - `Templates/` - Code generation templates
    - `Validator/` - Schema validation logic

- **`PolicyAdmin/`** - Policy and authorization management:
    - `Models/` - XACML policy models
    - `PolicyConverter.cs` - Policy format conversions

### Test Projects

- **`tests/Designer.Tests/`** - Unit and integration tests for main Designer project
- **`tests/DataModeling.Tests/`** - Tests for data modeling functionality
- **`tests/SharedResources.Tests/`** - Shared testing utilities

## Development Commands

### Build & Run

- `dotnet build` - Build the solution
- `dotnet run --project src/Designer` - Run the Designer API
- `dotnet watch --project src/Designer` - Run with hot reload

### Database

- `dotnet ef migrations add <MigrationName> --project src/Designer` - Add new migration
- `dotnet ef database update --project src/Designer` - Apply migrations

### Testing

- `dotnet test` - Run all tests
- `./runTests.sh` - Run tests with controller-specific filtering
- `dotnet test --filter "FullyQualifiedName~ControllerName"` - Run specific controller tests

## Architecture Patterns

### Domain-Driven Design

The backend follows clean architecture principles with clear separation of concerns:

- **Controllers** - Handle HTTP requests and coordinate with services
- **Services** - Contain business logic and orchestrate domain operations
- **Models** - Represent domain entities and data transfer objects
- **Infrastructure** - Handle external concerns (database, git, auth, etc.)

### Event-Driven Architecture

Uses MediatR for handling domain events:

- **Events** - Domain events representing state changes
- **EventHandlers** - Process events and trigger side effects
- **Commands** - Represent operations that change system state

### Integration Patterns

- **Git Repository Management** - LibGit2Sharp for source control operations
- **Real-time Updates** - SignalR hubs for live synchronization
- **Background Processing** - Quartz jobs for scheduled tasks
- **External Services** - Integration with Gitea, Azure DevOps, Maskinporten

## Configuration

Key configuration sections in `appsettings.json`:

- **PostgreSQLSettings** - Database connection configuration
- **ServiceRepositorySettings** - Git repository settings
- **PlatformSettings** - Altinn platform integration URLs
- **MaskinportenClientSettings** - Maskinporten authentication
- **ResourceRegistryIntegrationSettings** - Environment-specific settings
- **FeatureManagement** - Feature flags configuration

## Authentication & Authorization

- **OIDC Integration** - OpenID Connect with Gitea
- **AnsattPorten** - Norwegian government employee authentication
- **Maskinporten** - Machine-to-machine authentication
- **Policy-based Authorization** - Custom authorization handlers for Git operations

## Testing Guidelines

- Use `TestContainers` for integration tests requiring databases
- Mock external dependencies using `Moq`
- Follow AAA pattern (Arrange, Act, Assert)
- Use `WebApplicationFactory` for API integration tests
- Place test files in same folder structure as source files
