FROM --platform=$BUILDPLATFORM golang:1.25.6-trixie@sha256:fb4b74a39c7318d53539ebda43ccd3ecba6e447a78591889c0efc0a7235ea8b3 AS builder
ARG TARGETOS
ARG TARGETARCH

WORKDIR /app

COPY go.mod go.sum ./

# Remove the test fixture dependency from go.mod as it's not needed for building binaries
# The test/harness package is only imported by test files, not by cmd/proxy or cmd/worker
RUN sed -i '/altinn.studio\/runtime-fixture v/d' go.mod && \
    sed -i '/replace altinn.studio\/runtime-fixture/d' go.mod

RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -a -installsuffix cgo -o main ./cmd/worker

FROM docker.io/chromedp/headless-shell:stable@sha256:478f1105d06e921d7652c18ecf6d1fc81d9bf3c484ef39562b8e7760d42d71a8

USER root

ENV DEBIAN_FRONTEND=noninteractive
RUN echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections && \
    sed -i 's/main$/main contrib/' /etc/apt/sources.list.d/debian.sources && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        fontconfig \
        ttf-mscorefonts-installer && \
    fc-cache -f -v && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY --from=builder /app/main .

RUN mkdir -p ./output

EXPOSE 5031

RUN mkdir -p /tmp/user-home && \
    chown -R nobody:nogroup /tmp/user-home

ENV HOME=/tmp/user-home
USER nobody

ENTRYPOINT ["./main"]
