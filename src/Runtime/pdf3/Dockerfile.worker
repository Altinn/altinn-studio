FROM --platform=$BUILDPLATFORM golang:1.25.5-trixie@sha256:8e8f9c84609b6005af0a4a8227cee53d6226aab1c6dcb22daf5aeeb8b05480e1 AS builder
ARG TARGETOS
ARG TARGETARCH

WORKDIR /app

COPY go.mod go.sum ./

# Remove the test fixture dependency from go.mod as it's not needed for building binaries
# The test/harness package is only imported by test files, not by cmd/proxy or cmd/worker
RUN sed -i '/altinn.studio\/runtime-fixture v/d' go.mod && \
    sed -i '/replace altinn.studio\/runtime-fixture/d' go.mod

RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -a -installsuffix cgo -o main ./cmd/worker

FROM docker.io/chromedp/headless-shell:stable@sha256:de5b057849de96955de7662023420a46355abfbb24d57aa01282ec7c811aacab

USER root

ENV DEBIAN_FRONTEND=noninteractive
RUN echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | debconf-set-selections && \
    sed -i 's/main$/main contrib/' /etc/apt/sources.list.d/debian.sources && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        fontconfig \
        ttf-mscorefonts-installer && \
    fc-cache -f -v && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY --from=builder /app/main .

RUN mkdir -p ./output

EXPOSE 5031

RUN mkdir -p /tmp/user-home && \
    chown -R nobody:nogroup /tmp/user-home

ENV HOME=/tmp/user-home
USER nobody

ENTRYPOINT ["./main"]
