@model StartAppModel
@{
  ViewData["Title"] = "Altinn Studio Local Testing";
}

@{
  if (Model.IsAccessedViaLoadBalancer && Model.HasRegisteredApps)
  {
    <div class="alert alert-danger" role="alert">
      <h4>⚠️ Invalid Access Method</h4>
      <p>
        You are accessing LocalTest through the loadbalancer, but you have registered apps running in auto mode.
        This configuration is not supported.
      </p>
      <p>
        Please access LocalTest directly at: <strong><a href="http://local.altinn.cloud:5101">http://local.altinn.cloud:5101</a></strong>
      </p>
    </div>
  }
  else if (Model.HttpException != null)
  {
    <div class="alert alert-dark" role="alert">
      An exception occurred while fetching applicationData
      @if (Model.HttpException.StatusCode == System.Net.HttpStatusCode.Unauthorized) {
        <pre>401(Unauthorized) Could not access @(Model.LocalAppUrl)</pre>
        <p>
          You are currently running LocalTest in "http" mode, and this requires
          apps created before December 2021 to update to nuget packages to fix
          an access control issue.
        </p>
        <p>
          You can either change the setting "LocalPlatformSettings.LocalAppMode"
          to "file", or update the altinn nuget packages in your app to at least
          4.21.0
        </p>
        <p>
          See <a href="https://docs.altinn.studio/community/changelog/app-nuget/v4/breaking-changes/">https://docs.altinn.studio/community/changelog/app-nuget/v4/breaking-changes/</a> for instructions on how to update.
        </p>
      } else if(Model.HttpException.InnerException is System.Net.Sockets.SocketException) {
        @if(string.IsNullOrWhiteSpace(Model.LocalAppUrl)){
          <p>
            LocalTest is running in "LocalPlatformSettings.LocalAppMode" == "http" mode, but
            "LocalPlatformSettings.LocalAppUrl" is not set to a valid address.
          </p>
        } else {
          <pre>No application running on @Model.LocalAppUrl</pre>
          <p>
            Please start your an app on this address. Typically run the following command in an app directory.
          </p>
          <pre>dotnet run</pre>
        }
      } else {
        <pre>
          @(Model.HttpException.ToString())
          @(Model.HttpException.StackTrace.ToString())
        </pre>
      }
    </div>
  }
  else if (Model.TestApps == null || Model.TestApps.Any() == false)
  {
    <div class="alert alert-dark" role="alert">
      <p>No apps are currently running. This is typically done by running the following command in an app directory:</p>
      <pre>dotnet run</pre>
    </div>
  }
  else if (Model.InvalidAppPath)
  {
    <div class="alert alert-dark" role="alert">
      Check your configured app path in appsettings.json for localtest project  Can't find any Altinn App at this location: @Model.AppPath
    </div>

  }
  else if (Model.InvalidTestDataPath)
  {
    <div class="alert alert-dark" role="alert">
      Check your configured path to the cloned testdata for localtest project. Current path configured is: @Model.StaticTestDataPath
    </div>
  }
  else
  {
  <div class="text-center">
    <h1 class="display-4">Welcome to Altinn App Local Testing</h1>
    <p>Learn about <a href="https://docs.altinn.studio" target="_blank">building and testing Altinn Apps</a>.</p>

    @if(Model.TestApps != null && Model.TestApps.Count() == 1)
    {
      <h2>Testing app:  @Model.TestApps.First().Text</h2>
    }

    @if(Model.TestApps != null && Model.TestApps.Any())
    {
      @using (Html.BeginForm("LogInTestUser", "Home", FormMethod.Post, new { Class = "form-signin", enctype = "multipart/form-data" }))
      {
        @Html.AntiForgeryToken();
        @if(Model.TestApps != null && Model.TestApps.Count() > 1)
        {
          <div class="form-group">
            <label for="AppPathSelection">Select app to test</label>
            @Html.DropDownListFor(model => model.AppPathSelection, Model.TestApps, new { Class = "form-control", id = "AppPathSelection" })
          </div>
        }
        <div class="form-group">
          <label for="UserSelect">Select test users</label>
          @Html.DropDownListFor(model => model.UserSelect, Model.TestUsers, new { Class = "form-control", id = "UserSelect" })
        </div>
        <div class="form-group">
          <label for="AuthenticationLevel">Select your authentication level</label>
          @Html.DropDownListFor(model => model.AuthenticationLevel, Model.AuthenticationLevels, new { Class = "form-control" })
        </div>
        <div class="form-group">
          <label for="prefill">
            Prefill xml (use this to copy all the values from a <a id="prefillLink" href="/LocalPlatformStorage/blobs/@(Model.TestApps?.FirstOrDefault()?.Text ?? "")">previous instance</a>)<br />
            A token autenticated as <strong id="prefillOrg">@(Model.TestApps?.FirstOrDefault()?.Text?.Split("/").FirstOrDefault() ?? "")</strong> will be used for for instantiation
          </label>
          <input class="form-control" type="file" id="prefill" name="prefill" accept=".xml"/>
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-light" name="action" value="reauthenticate">Refresh authentication</button>
          <button type="submit" class="btn btn-primary" name="action" value="start">Proceed to app</button>
        </div>
      }
    }

    @if(!string.IsNullOrWhiteSpace(Model.LocalFrontendUrl))
    {
      <div class="alert alert-primary" role="alert">
        You are using frontend js and css from @(Model.LocalFrontendUrl). @Html.ActionLink("Use a different frontend version", "Index", "FrontendVersion")
      </div>
    }
  </div>
  }
}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var appSelect = document.getElementById('AppPathSelection');
    var prefillLink = document.getElementById('prefillLink');
    var prefillOrg = document.getElementById('prefillOrg');

    if (appSelect && prefillLink && prefillOrg) {
      appSelect.addEventListener('change', function() {
        var selectedApp = appSelect.options[appSelect.selectedIndex].text;
        prefillLink.href = '/LocalPlatformStorage/blobs/' + selectedApp;
        var org = selectedApp.split('/')[0];
        prefillOrg.textContent = org;
      });
    }
  });
</script>
