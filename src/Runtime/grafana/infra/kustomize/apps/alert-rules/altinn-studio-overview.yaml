apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaAlertRuleGroup
metadata:
  name: Exceptions
spec:
  folderRef: external-grafana-altinn-studio
  instanceSelector:
    matchLabels:
      dashboards: 'external-grafana'
  interval: 5m
  rules:
    - uid: fezx7fvy20k5cb
      title: 5xx failed requests
      condition: C
      data:
        - refId: A
          queryType: Azure Monitor
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: azure-monitor-oob
          model:
            azureMonitor:
              aggregation: Count
              alias: '{{cloud/rolename}}'
              allowedTimeGrainsMs:
                - 60000
                - 300000
                - 900000
                - 1.8e+06
                - 3.6e+06
                - 2.16e+07
                - 4.32e+07
                - 8.64e+07
              customNamespace: ''
              dimensionFilters:
                - dimension: cloud/roleName
                  filters: []
                  operator: eq
                - dimension: request/resultCode
                  filters:
                    - '500'
                    - '501'
                    - '502'
                    - '503'
                    - '504'
                    - '505'
                    - '506'
                    - '507'
                    - '508'
                    - '510'
                    - '511'
                  operator: eq
              metricName: requests/failed
              metricNamespace: microsoft.insights/components
              region: norwayeast
              resources:
                - metricNamespace: Microsoft.Insights/components
                  region: norwayeast
                  resourceGroup: monitor-ttd-tt02-rg
                  resourceName: ttd-tt02-ai
                  subscription: ca0666d3-b3c0-4159-93f1-b71777ed4338
              timeGrain: auto
              top: '10'
            datasource:
              apiVersion: '2018-01-01'
              type: grafana-azure-monitor-datasource
              uid: azure-monitor-oob
            instant: false
            intervalMs: 1000
            maxDataPoints: 43200
            queryType: Azure Monitor
            range: true
            refId: A
            subscription: ca0666d3-b3c0-4159-93f1-b71777ed4338
        - refId: B
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params: []
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - B
                reducer:
                  params: []
                  type: max
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: A
            intervalMs: 1000
            maxDataPoints: 43200
            reducer: max
            refId: B
            type: reduce
        - refId: C
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params:
                    - 0
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - C
                reducer:
                  params: []
                  type: last
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: B
            intervalMs: 1000
            maxDataPoints: 43200
            refId: C
            type: threshold
      dashboardUid: AltinnStudioOverview
      panelId: 3
      noDataState: OK
      execErrState: Error
      annotations:
        __dashboardUid__: AltinnStudioOverview
        __panelId__: '3'
        summary: '`{{ index $labels "cloud/rolename" }}` had 5xx failed requests in the last 5m'
      labels:
        Type: Altinn
      isPaused: true
    - uid: aezx7i0inylfkd
      title: Server exceptions
      condition: C
      data:
        - refId: A
          queryType: Azure Monitor
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: azure-monitor-oob
          model:
            azureMonitor:
              aggregation: Count
              alias: '{{cloud/rolename}}'
              allowedTimeGrainsMs:
                - 60000
                - 300000
                - 900000
                - 1.8e+06
                - 3.6e+06
                - 2.16e+07
                - 4.32e+07
                - 8.64e+07
              customNamespace: ''
              dimensionFilters:
                - dimension: cloud/roleName
                  filters: []
                  operator: eq
              metricName: exceptions/server
              metricNamespace: microsoft.insights/components
              region: norwayeast
              resources:
                - metricNamespace: Microsoft.Insights/components
                  region: norwayeast
                  resourceGroup: monitor-ttd-tt02-rg
                  resourceName: ttd-tt02-ai
                  subscription: ca0666d3-b3c0-4159-93f1-b71777ed4338
              timeGrain: auto
              top: '10'
            datasource:
              apiVersion: '2018-01-01'
              type: grafana-azure-monitor-datasource
              uid: azure-monitor-oob
            instant: false
            intervalMs: 1000
            maxDataPoints: 43200
            queryType: Azure Monitor
            range: true
            refId: A
            subscription: ca0666d3-b3c0-4159-93f1-b71777ed4338
        - refId: B
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params: []
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - B
                reducer:
                  params: []
                  type: max
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: A
            intervalMs: 1000
            maxDataPoints: 43200
            reducer: max
            refId: B
            type: reduce
        - refId: C
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params:
                    - 0
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - C
                reducer:
                  params: []
                  type: last
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: B
            intervalMs: 1000
            maxDataPoints: 43200
            refId: C
            type: threshold
      dashboardUid: AltinnStudioOverview
      panelId: 4
      noDataState: OK
      execErrState: Error
      annotations:
        __dashboardUid__: AltinnStudioOverview
        __panelId__: '4'
        summary: '`{{ index $labels "cloud/rolename" }}` had exceptions in the last 5m'
      labels:
        Type: Altinn
      isPaused: true
    - uid: aezx7gzgep4aob
      title: Server response time
      condition: C
      data:
        - refId: A
          queryType: Azure Monitor
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: azure-monitor-oob
          model:
            azureMonitor:
              aggregation: Average
              alias: '{{cloud/rolename}}'
              allowedTimeGrainsMs:
                - 60000
                - 300000
                - 900000
                - 1.8e+06
                - 3.6e+06
                - 2.16e+07
                - 4.32e+07
                - 8.64e+07
              customNamespace: ''
              dimensionFilters:
                - dimension: cloud/roleName
                  filters: []
                  operator: eq
              metricName: requests/duration
              metricNamespace: microsoft.insights/components
              region: norwayeast
              resources:
                - metricNamespace: Microsoft.Insights/components
                  region: norwayeast
                  resourceGroup: monitor-ttd-tt02-rg
                  resourceName: ttd-tt02-ai
                  subscription: ca0666d3-b3c0-4159-93f1-b71777ed4338
              timeGrain: auto
              top: '10'
            datasource:
              apiVersion: '2018-01-01'
              type: grafana-azure-monitor-datasource
              uid: azure-monitor-oob
            instant: false
            intervalMs: 1000
            maxDataPoints: 43200
            queryType: Azure Monitor
            range: true
            refId: A
            subscription: ca0666d3-b3c0-4159-93f1-b71777ed4338
        - refId: B
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params: []
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - B
                reducer:
                  params: []
                  type: max
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: A
            intervalMs: 1000
            maxDataPoints: 43200
            reducer: max
            refId: B
            type: reduce
        - refId: C
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params:
                    - 1000
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - C
                reducer:
                  params: []
                  type: last
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: B
            intervalMs: 1000
            maxDataPoints: 43200
            refId: C
            type: threshold
      dashboardUid: AltinnStudioOverview
      panelId: 2
      noDataState: OK
      execErrState: Error
      annotations:
        __dashboardUid__: AltinnStudioOverview
        __panelId__: '2'
        summary: '`{{ index $labels "cloud/rolename" }}` had slow requests in the last 5m'
      labels:
        Type: Altinn
      isPaused: true
    - uid: dezx79y99vj7kb
      title: Server requests
      condition: C
      data:
        - refId: A
          queryType: Azure Monitor
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: azure-monitor-oob
          model:
            azureMonitor:
              aggregation: Count
              alias: '{{cloud/rolename}}'
              allowedTimeGrainsMs:
                - 60000
                - 300000
                - 900000
                - 1.8e+06
                - 3.6e+06
                - 2.16e+07
                - 4.32e+07
                - 8.64e+07
              customNamespace: ''
              dimensionFilters:
                - dimension: cloud/roleName
                  filters: []
                  operator: eq
              metricName: requests/count
              metricNamespace: microsoft.insights/components
              region: norwayeast
              resources:
                - metricNamespace: Microsoft.Insights/components
                  region: norwayeast
                  resourceGroup: monitor-ttd-tt02-rg
                  resourceName: ttd-tt02-ai
                  subscription: ca0666d3-b3c0-4159-93f1-b71777ed4338
              timeGrain: auto
              top: '10'
            datasource:
              apiVersion: '2018-01-01'
              type: grafana-azure-monitor-datasource
              uid: azure-monitor-oob
            instant: false
            intervalMs: 1000
            maxDataPoints: 43200
            queryType: Azure Monitor
            range: true
            refId: A
            subscription: ca0666d3-b3c0-4159-93f1-b71777ed4338
        - refId: B
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params: []
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - B
                reducer:
                  params: []
                  type: max
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: A
            intervalMs: 1000
            maxDataPoints: 43200
            reducer: max
            refId: B
            type: reduce
        - refId: C
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params:
                    - 1000
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - C
                reducer:
                  params: []
                  type: last
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: B
            intervalMs: 1000
            maxDataPoints: 43200
            refId: C
            type: threshold
      dashboardUid: AltinnStudioOverview
      panelId: 10
      noDataState: OK
      execErrState: Error
      annotations:
        __dashboardUid__: AltinnStudioOverview
        __panelId__: '10'
        summary: '`{{ index $labels "cloud/rolename" }}` had a surge in requests in the last 5m'
      labels:
        Type: Altinn
      isPaused: true
    - uid: fezx7j424lj40c
      title: Memory usage
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: ttd-tt02-amw
          model:
            adhocFilters: []
            datasource:
              type: prometheus
              uid: ttd-tt02-amw
            editorMode: code
            expr: |-
              sum(
                          container_memory_working_set_bytes{namespace="default", container!="", image!=""}
                          * on(namespace,pod)
                          group_left(workload, workload_type)
                          namespace_workload_pod:kube_pod_owner:relabel{
                              namespace="default",
                              workload_type="deployment",
                              workload=~"^ttd-(.*)-deployment-v2$"
                          }
                      ) by (workload)
                      /
                      sum(
                          kube_pod_container_resource_requests{namespace="default", container!="", resource="memory"}
                          * on(namespace,pod)
                          group_left(workload, workload_type)
                          namespace_workload_pod:kube_pod_owner:relabel{
                              namespace="default",
                              workload_type="deployment",
                              workload=~"^ttd-(.*)-deployment-v2$"
                          }
                      ) by (workload)
                      * 100
            instant: false
            interval: ''
            intervalMs: 30000
            legendFormat: __auto
            maxDataPoints: 43200
            range: true
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params: []
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - B
                reducer:
                  params: []
                  type: max
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: A
            intervalMs: 1000
            maxDataPoints: 43200
            reducer: max
            refId: B
            type: reduce
        - refId: C
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params:
                    - 80
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - C
                reducer:
                  params: []
                  type: last
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: B
            intervalMs: 1000
            maxDataPoints: 43200
            refId: C
            type: threshold
      dashboardUid: AltinnStudioOverview
      panelId: 5
      noDataState: NoData
      execErrState: Error
      annotations:
        __dashboardUid__: AltinnStudioOverview
        __panelId__: '5'
        summary: '`{{ $labels.workload }}` had memory pressure in the last 5m'
      labels:
        Type: Altinn
      isPaused: true
    - uid: aezx7k0328cn4f
      title: CPU usage
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: ttd-tt02-amw
          model:
            adhocFilters: []
            datasource:
              type: prometheus
              uid: ttd-tt02-amw
            editorMode: code
            expr: |-
              sum(
                              sum by (namespace, pod, container) (
                                  rate(container_cpu_usage_seconds_total{namespace="default", container!=""}[5m])
                              )
                              * on(namespace,pod)
                              group_left(workload, workload_type)
                              namespace_workload_pod:kube_pod_owner:relabel{
                                  namespace="default",
                                  workload_type="deployment",
                                  workload=~"^ttd-(.*)-deployment-v2$"
                              }
                          ) by (workload)
                          /
                          sum(
                              kube_pod_container_resource_requests{namespace="default", container!="", resource="cpu"}
                              * on(namespace,pod)
                              group_left(workload, workload_type)
                              namespace_workload_pod:kube_pod_owner:relabel{
                                  namespace="default",
                                  workload_type="deployment",
                                  workload=~"^ttd-(.*)-deployment-v2$"
                              }
                          ) by (workload)
                          * 100
            instant: false
            interval: ''
            intervalMs: 30000
            legendFormat: __auto
            maxDataPoints: 43200
            range: true
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params: []
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - B
                reducer:
                  params: []
                  type: max
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: A
            intervalMs: 1000
            maxDataPoints: 43200
            reducer: max
            refId: B
            type: reduce
        - refId: C
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params:
                    - 80
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - C
                reducer:
                  params: []
                  type: last
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: B
            intervalMs: 1000
            maxDataPoints: 43200
            refId: C
            type: threshold
      dashboardUid: AltinnStudioOverview
      panelId: 6
      noDataState: NoData
      execErrState: Error
      annotations:
        __dashboardUid__: AltinnStudioOverview
        __panelId__: '6'
        summary: '`{{ $labels.workload }}` had cpu pressure in the last 5m'
      labels:
        Type: Altinn
      isPaused: true
    - uid: eezx7l7eytm9se
      title: Availability
      condition: C
      data:
        - refId: A
          relativeTimeRange:
            from: 300
            to: 0
          datasourceUid: ttd-tt02-amw
          model:
            adhocFilters: []
            datasource:
              type: prometheus
              uid: ttd-tt02-amw
            editorMode: code
            expr: |-
              (
                  kube_deployment_status_replicas_available{namespace="default"}
                  >= bool kube_deployment_spec_replicas{namespace="default"}
              )
              OR on(namespace, deployment)
              (absent(kube_deployment_spec_replicas{namespace="default"}) * 0)
            instant: false
            interval: ''
            intervalMs: 30000
            legendFormat: __auto
            maxDataPoints: 43200
            range: true
            refId: A
        - refId: B
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params: []
                  type: gt
                operator:
                  type: and
                query:
                  params:
                    - B
                reducer:
                  params: []
                  type: max
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: A
            intervalMs: 1000
            maxDataPoints: 43200
            reducer: max
            refId: B
            type: reduce
        - refId: C
          datasourceUid: __expr__
          model:
            conditions:
              - evaluator:
                  params:
                    - 100
                  type: lt
                operator:
                  type: and
                query:
                  params:
                    - C
                reducer:
                  params: []
                  type: last
                type: query
            datasource:
              type: __expr__
              uid: __expr__
            expression: B
            intervalMs: 1000
            maxDataPoints: 43200
            refId: C
            type: threshold
      dashboardUid: AltinnStudioOverview
      panelId: 7
      noDataState: NoData
      execErrState: Error
      annotations:
        __dashboardUid__: AltinnStudioOverview
        __panelId__: '7'
        summary: '`{{ $labels.deployment }}` was down in the last 5m'
      labels:
        Type: Altinn
      isPaused: true
