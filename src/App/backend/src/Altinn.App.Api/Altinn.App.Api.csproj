<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <OutputType>Library</OutputType>
    <PackageTags>Altinn;Studio;App;Api;Controllers</PackageTags>
    <Description>
      This class library holds all the API controllers used by a standard Altinn 3 App.
    </Description>
    <IsPackable>true</IsPackable>

    <!-- SonarCloud requires a ProjectGuid to separate projects. -->
    <ProjectGuid>{E8F29FE8-6B62-41F1-A08C-2A318DD08BB4}</ProjectGuid>
    <DebugType>portable</DebugType>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Altinn.Common.PEP"/>
    <PackageReference Include="Altinn.Platform.Storage.Interface"/>
    <PackageReference Include="Microsoft.FeatureManagement.AspNetCore"/>
    <PackageReference Include="OpenTelemetry.Exporter.OpenTelemetryProtocol"/>
    <PackageReference Include="OpenTelemetry.Extensions.Hosting"/>
    <PackageReference Include="OpenTelemetry.Instrumentation.AspNetCore"/>
    <PackageReference Include="OpenTelemetry.Instrumentation.Http"/>
    <PackageReference Include="OpenTelemetry.Instrumentation.Runtime"/>
    <PackageReference Include="Azure.Monitor.OpenTelemetry.Exporter"/>
    <PackageReference Include="Azure.Identity"/>
    <PackageReference Include="Azure.Extensions.AspNetCore.Configuration.Secrets"/>
    <PackageReference Include="Swashbuckle.AspNetCore"/>
    <PackageReference Include="Microsoft.OpenApi"/>
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="../Altinn.App.Core/Altinn.App.Core.csproj" />
  </ItemGroup>

  <ItemGroup>
    <!-- Internal analyzers are for analysis of _our_ code, so we reference this project as an analyzer (it's a build-time dep) -->
    <ProjectReference Include="../Altinn.App.Internal.Analyzers/Altinn.App.Internal.Analyzers.csproj" PrivateAssets="all" ReferenceOutputAssembly="false" OutputItemType="Analyzer" />
    <!-- We reference the app analyzers to make sure it's built, but we don't really reference it. We just include it in packaging below -->
    <ProjectReference Include="../Altinn.App.Analyzers/Altinn.App.Analyzers.csproj" PrivateAssets="all" ReferenceOutputAssembly="false" OutputItemType="None" />
    <!-- This makes sure that the app analyzers is bundled alongside Altinn.App.Api when referenced in an app -->
    <None Include="../Altinn.App.Analyzers/bin/$(Configuration)/netstandard2.0/Altinn.App.Analyzers.dll" Pack="true" PackagePath="analyzers/dotnet/cs" Visible="true" />
    <!-- We will probably use System.Text.Json while analyzing in the future, this setup has been tested -->
    <!-- <None Include="../Altinn.App.Analyzers/bin/$(Configuration)/netstandard2.0/System.Text.Json.dll" Pack="true" PackagePath="analyzers/dotnet/cs" Visible="true" /> -->
    <!-- These MSBuild props are applied to the app when they reference the Altinn.App.Api package. Used for <AdditionalFile /> inclusions etc. -->
    <None Include="packaging/Altinn.App.Api.props" Pack="true" PackagePath="build/" Visible="true" Condition="'$(MinVerVersionOverride)'==''" />
    <!--
      When we do PR builds/experimental releases we set tne MinVerVersionOverride from CI, and we also append '.Experimental' to package IDs.
      The props file name must match the package ID for the package it is included in.
     -->
    <None Include="packaging/Altinn.App.Api.Experimental.props" Pack="true" PackagePath="build/" Visible="true" Condition="'$(MinVerVersionOverride)'!=''" />
  </ItemGroup>

  <Target Name="CreateExperimentalPropsFile" AfterTargets="Build" Condition="'$(MinVerVersionOverride)'!=''">
    <!-- For PR/experimental builds we need to rename the props file (only happens in CI) -->
    <Move SourceFiles="packaging/Altinn.App.Api.props" DestinationFiles="packaging/Altinn.App.Api.Experimental.props"/>
  </Target>

  <ItemGroup>
    <InternalsVisibleTo Include="$(AssemblyName).Tests" />
    <InternalsVisibleTo Include="Altinn.App.Benchmarks" />
    <InternalsVisibleTo Include="Altinn.App.Tests.Common" />
    <InternalsVisibleTo Include="DynamicProxyGenAssembly2" />
    <InternalsVisibleTo Include="Altinn.Application.For.IntegrationTesting" />
    <InternalsVisibleTo Include="Altinn.Application.For.IntegrationTesting.Scenario" />
  </ItemGroup>
</Project>
