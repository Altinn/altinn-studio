# Phase 01.1: Parity and Contract Addendum

## Objective

Make the bootstrap refactor executable with low regression risk by defining:

1. Explicit behavior parity requirements
2. A compatibility strategy for existing frontend consumers
3. Contract/integration test requirements
4. Performance and payload guardrails

This addendum is mandatory before Phase 3 deletions.

---

## Scope Clarification

- Ignore layout quirks as a migration concern in this major version.
- Keep dynamic options flow as-is (not bundled in bootstrap).
- Keep old endpoints available for backwards compatibility.

---

## Parity Matrix (Must-Haves)

| Existing concern                     | Current source                                 | Required bootstrap-era source                        | Requirement                                  |
| ------------------------------------ | ---------------------------------------------- | ---------------------------------------------------- | -------------------------------------------- |
| Layouts and page metadata            | `LayoutsContext` + `LayoutSettingsContext`     | Bootstrap response (`layouts`, `layoutSettings`)     | Same visible page order/navigation behavior  |
| Data model type discovery            | `DataModelsProvider` layout scanning           | Backend layout analysis result                       | Same referenced data types set               |
| Default/readable/writable data types | `DataModelsProvider` state                     | Bootstrap metadata + data model entries              | Same write restrictions and locking behavior |
| Initial data and data element IDs    | `useFormDataQuery` + instance data mapping     | `dataModels[*].initialData` + `dataElementId`        | Same initial values and save targets         |
| Schema lookup and binding validation | `useDataModelSchemaQuery` + `SchemaLookupTool` | Bootstrap schema payload + same lookup tooling       | Same binding/schema validation behavior      |
| Expression validation config         | `useCustomValidationConfigQuery`               | Bootstrap `expressionValidationConfig`               | Same resolved config behavior in FE          |
| Initial backend validations          | `useBackendValidationQuery`                    | Bootstrap `validationIssues` (when enabled)          | Same initial validation visibility/outcome   |
| `optionLabel` expression support     | `CodeListsProvider` store                      | Bootstrap static options + compatible selector API   | `optionLabel` must not regress               |
| Pending options semantics            | `CodeListPending`                              | Compatibility layer behavior                         | No runtime expression breakage               |
| Subform context overrides            | `TaskOverrides`                                | Bootstrap overrides (`layoutSetId`, `dataElementId`) | Same subform data and navigation behavior    |

---

## Frontend Compatibility Strategy

Phase 3 must not directly delete old APIs without a compatibility bridge.

### 1) DataModels compatibility facade

Introduce a bootstrap-backed facade that preserves `DataModels` selector contracts used by:

- `FormDataWrite`
- Validation providers
- Expression/runtime consumers
- Layout components and utilities

Acceptance criteria:

- Existing `DataModels.use*` calls compile unchanged
- Behavior is equivalent for all currently supported flows

### 2) Code list compatibility facade

Preserve `optionLabel` behavior without forcing expression engine changes in same phase.

Acceptance criteria:

- Expression runtime still uses selector contract
- Missing static option does not hard-crash form runtime
- Dynamic options remain served by existing options query path

### 3) TaskOverrides deprecation path

Do not remove `TaskOverrides` blindly. Decommission only after all consumers are migrated.

Acceptance criteria:

- No remaining runtime dependency on `useTaskOverrides` for form bootstrap paths
- Subform and nested subform flows continue to work

---

## Backend Contract Requirements

Define the response contract as versioned and stable.

Required fields:

- `schemaVersion`
- `layouts`
- `layoutSettings`
- `dataModels`
- `staticOptions`
- `metadata`

Conditional fields:

- `validationIssues` (instance, non-PDF, validation enabled)

Rules:

- Missing data for one model/options entry should not fail entire response
- Errors should be logged with sufficient context
- Endpoint should be non-cacheable at HTTP level

---

## Validation and Behavior Gating

Initial validation inclusion must mirror existing behavior gates:

- Exclude for stateless
- Exclude for PDF
- Exclude when no writable data types
- Exclude for custom receipt contexts (if applicable in endpoint usage)

Expression validation config inclusion must mirror existing write rules:

- Exclude for locked/read-only elements
- Exclude for PDF

---

## Contract and Integration Tests (Required)

Add focused tests before broad E2E verification.

### Backend integration tests

1. Instance bootstrap returns expected shape for normal task
2. Stateless bootstrap returns expected shape for `onEntry.show` layout set
3. Subform overrides (`layoutSetId`, `dataElementId`) return matching data type
4. PDF mode excludes initial validation and expression validation config
5. Static options include statically fetchable options and optionLabel references
6. Partial failure case returns remaining valid data

### Frontend contract tests

1. Bootstrap-backed `DataModels` facade parity for key selectors
2. `optionLabel` expressions resolve from bootstrap options
3. FormDataWrite saves against correct `dataElementId`
4. Initial backend validation state is seeded correctly from bootstrap payload

---

## Performance and Payload Guardrails

Define targets and measure before/after:

1. Request count to first interactive form render should be reduced materially
2. P95 time-to-first-render should be non-regressive, target improvement
3. Payload size should be monitored and reported for representative apps

Minimum reporting for PR/epic:

- Before/after request waterfall snapshot
- Before/after payload size
- Before/after P95 form bootstrap latency

---

## Exit Criteria for Deleting Old Providers

You may delete `DataModelsProvider`, `CodeListsProvider`, and related hooks only when:

1. Compatibility facades are in place and used
2. Backend + frontend contract tests pass
3. Existing E2E suite passes
4. Subform and PDF scenarios are verified
5. Perf guardrails are checked and non-regressive

---

## Implementation Order Update

1. Phase 1: Core service
2. Phase 1.1: Contract + parity addendum requirements implemented
3. Phase 2: Endpoints
4. Phase 3: Frontend provider + compatibility facades
5. Phase 4: Subforms + TaskOverrides deprecation
6. Phase 5: Contract tests + E2E + perf verification
