worker_processes 1;

events {
	worker_connections 1024;
}

http {

  proxy_buffer_size    128k;
  proxy_buffers   8 256k;
  proxy_busy_buffers_size   512k;
  large_client_header_buffers 64 16k;

	client_max_body_size 50M;

	upstream designer {
		server host.docker.internal:6000;
	}

	upstream repositories {
		server host.docker.internal:3000;
	}

	server {
		set $dev_app_development $DEVELOP_APP_DEVELOPMENT;
		set $dev_resource_admin $DEVELOP_RESOURCE_ADMIN;
		set $dev_app_preview $DEVELOP_PREVIEW;
		set $dev_backend $DEVELOP_BACKEND;
		set $dev_dashboard $DEVELOP_DASHBOARD;
		set $dev_studio_root $DEVELOP_STUDIO_ROOT;

		server_name studio.localhost;

		proxy_cookie_path ~*^/.* /;
		proxy_redirect off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		error_page 502 /502Designer.html;

		location = / {
			if ($dev_backend) {
				add_header X-Dashboard-Source dotnetRoot;
				proxy_pass http://host.docker.internal:5000;
			}
			if ($dev_backend != 1) {
				add_header X-Dashboard-Source dockerRoot;
				proxy_pass http://designer;
			}
		}

		location ^~ /login {
			if ($dev_backend) {
				add_header X-Dashboard-Source dotnetPaths;
				proxy_pass http://host.docker.internal:5000;
			}
			if ($dev_backend != 1) {
				add_header X-Dashboard-Source dockerPaths;
				proxy_pass http://designer;
			}
		}

		location ^~ /signin-oidc {
			if ($dev_backend) {
				add_header X-Dashboard-Source dotnetPaths;
				proxy_pass http://host.docker.internal:5000;
			}
			if ($dev_backend != 1) {
				add_header X-Dashboard-Source dockerPaths;
				proxy_pass http://designer;
			}
		}

		location ^~ /designer/ {
			if ($dev_backend) {
				add_header X-Dashboard-Source dotnetPaths;
				proxy_pass http://host.docker.internal:5000;
			}
			if ($dev_backend != 1) {
				add_header X-Dashboard-Source dockerPaths;
				proxy_pass http://designer;
			}
		}

    location ^~ /dashboard/assets {
      proxy_pass http://designer;
    }

    location ^~ /dashboard/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      if ($dev_dashboard) {
        proxy_pass http://host.docker.internal:2003;
      }
      if ($dev_dashboard != 1) {
        rewrite ^/dashboard/.*$ /dashboard/index.html break;
      }
      proxy_pass http://designer/dashboard/;
    }

    location ^~ /editor/assets {
      proxy_pass http://designer;
    }

    location ^~ /editor/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      if ($dev_app_development) {
        proxy_pass http://host.docker.internal:2004;
      }
      if ($dev_app_development != 1) {
        rewrite ^/editor/.*$ /editor/index.html break;
      }
      proxy_pass http://designer/editor/;
    }

    location ^~ /preview/assets {
      proxy_pass http://designer;
    }

    location ^~ /preview/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      if ($dev_app_preview) {
        proxy_pass http://host.docker.internal:2005;
      }
      if ($dev_app_preview != 1) {
        rewrite ^/preview/.*$ /preview/index.html break;
      }
      proxy_pass http://designer/preview/;
    }

    location ^~ /resourceadm/assets {
      proxy_pass http://designer;
    }

    location ^~ /resourceadm/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      if ($dev_resource_admin) {
        proxy_pass http://host.docker.internal:2023;
      }
      if ($dev_resource_admin != 1) {
        rewrite ^/.*$ /resourceadm/index.html break;
      }
      proxy_pass http://designer/resourceadm/;
    }

    location ^~ /hubs/ {
      proxy_http_version  1.1;
      proxy_set_header    Upgrade $http_upgrade;
      proxy_set_header    Connection "Upgrade";
      if ($dev_backend) {
        add_header X-Dashboard-Source dotnetPaths;
        proxy_pass http://host.docker.internal:5000;
      }
      if ($dev_backend != 1) {
        add_header X-Dashboard-Source dockerPaths;
        proxy_pass http://designer;
      }
    }

    location ^~ /info/assets {
      proxy_pass http://designer/studio-root/assets;
    }

    location /info/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      if ($dev_studio_root) {
        proxy_pass http://host.docker.internal:2002;
      }
      if ($dev_studio_root != 1) {
        rewrite ^/.*$ /studio-root/index.html break;
      }
      proxy_pass http://designer/studio-root/;
    }


		location /repos/ {
			proxy_pass http://repositories/;
			error_page 502 /502Repo.html;
		}

		location /502Designer.html {
			root /www;
		}

		location /502Repo.html {
			root /www;
		}
	}
}
