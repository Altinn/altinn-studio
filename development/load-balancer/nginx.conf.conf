worker_processes 1;

events {
	worker_connections 1024;
}

http {

	client_max_body_size 50M;

	sendfile on;

	upstream designer {
		server host.docker.internal:6000;
	}

	upstream repositories {
		server host.docker.internal:3000;
	}

	upstream localtest {
		server host.docker.internal:5101;
	}

	upstream app {
		server host.docker.internal:5005;
	}

	upstream pdfservice {
		server host.docker.internal:5300;
	}

	server {
		listen 80;
		server_name localhost;
		return 307 $scheme://studio.localhost;
	}

	server {
		set $dev_backend $DEVELOP_BACKEND;
		set $dev_dashboard $DEVELOP_DASHBOARD;
		set $dev_app_development $DEVELOP_APP_DEVELOPMENT;

		listen 80;
		server_name studio.localhost;

		proxy_cookie_path ~*^/.* /;
		proxy_redirect off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		error_page 502 /502Designer.html;

		rewrite ^/.*/.*/staticfiles(.*)$ $1 last;

		location ^~ /designer/frontend/dashboard/ {
			proxy_redirect off;
			proxy_set_header Host $host;
			if ($dev_dashboard) {
				add_header X-Dashboard-Source webpackDash;
				rewrite /designer/frontend/dashboard/(.*) /$1 break;
				proxy_pass http://host.docker.internal:2003;
			}
			if ($dev_dashboard != 1) {
				add_header X-Dashboard-Source dockerDash;
				proxy_pass http://studio-designer:6000;
			}
		}

		location ^~ /designer/frontend/app-development/ {
			proxy_redirect off;
			proxy_set_header Host $host;
			if ($dev_app_development) {
				add_header X-Dashboard-Source webpackAppDev;
				rewrite /designer/frontend/app-development/(.*) /$1 break;
				proxy_pass http://host.docker.internal:2004;
			}
			if ($dev_app_development != 1) {
				add_header X-Dashboard-Source dockerAppDev;
				proxy_pass http://studio-designer:6000;
			}
		}

		location ^~ /designer/frontend/lang/ {
			default_type application/json;
			root /www-root;
		}

		location ~ ^/(Home|designer|designerapi)/ {
			proxy_redirect off;
			proxy_set_header Host $host;
			if ($dev_backend) {
				add_header X-Dashboard-Source dotnetPaths;
				proxy_pass http://host.docker.internal:5000;
			}
			if ($dev_backend != 1) {
				add_header X-Dashboard-Source dockerPaths;
				proxy_pass http://studio-designer:6000;
			}
		}

		location / {
			if ($dev_backend) {
				add_header X-Dashboard-Source dotnetRoot;
				proxy_pass http://host.docker.internal:5000;
			}
			if ($dev_backend != 1) {
				add_header X-Dashboard-Source dockerRoot;
				proxy_pass http://studio-designer:6000;
			}
		}

		location /repos/ {
			proxy_pass http://repositories/;
			error_page 502 /502Repo.html;
		}

		location /502Designer.html {
			root /www;
		}

		location /502Repo.html {
			root /www;
		}
	}

	server {

		listen 80;
		server_name $TEST_DOMAIM;

		proxy_redirect off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

		error_page 502 /502LocalTest.html;

		location = / {
			proxy_pass http://localtest/Home/;
		}

		location / {
			#Support using Local js, when a cookie value is set
			sub_filter_once off;
			sub_filter 'https://altinncdn.no/toolkits/altinn-app-frontend/3/' $LOCAL_SUB_FILTER;
			proxy_pass http://app/;
			error_page 502 /502App.html;
			proxy_cookie_domain altinn3local.no local.altinn.cloud;
		}

		location /Home/ {
			proxy_pass http://localtest/Home/;
		}

		location /storage/ {
			proxy_pass http://localtest/storage/;
		}

		location /localtestresources/ {
			proxy_pass http://localtest/localtestresources/;
		}

		location /LocalPlatformStorage/ {
			proxy_pass http://localtest/LocalPlatformStorage/;
		}

		location /pdfservice/ {
			proxy_pass http://pdfservice/;
		}

		location /502LocalTest.html {
			root /www;
		}

		location /502App.html {
			root /www;
		}

		location /502Receipt.html {
			root /www;
		}

		location /502Accessmanagement.html {
			root /www;
		}

	}
}
