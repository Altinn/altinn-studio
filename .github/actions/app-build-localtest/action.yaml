name: "App Build Localtest"
description: "Builds localtest Docker images"
inputs:
  docker-profile:
    description: "Which docker profile to use"
    required: false
runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5


    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

    - name: Login to GitHub Container Registry
      if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request'
      uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: Build localtest
      working-directory: src/Runtime/localtest
      env:
        DOCKER_BUILDKIT: 1
        COMPOSE_DOCKER_CLI_BUILD: 1
        BUILDKIT_PROGRESS: plain
        COMPOSE_FILE: 'docker-compose.yml:docker-compose.ci.yml'
      run: |
        args=""
        if [[ "${{ inputs.docker-profile }}" != "" ]]; then
          args="--profile ${{ inputs.docker-profile }}"
        fi

        if ! docker compose $args build; then
          echo "Failed to build localtest Docker images"
          exit 1
        fi
      shell: bash
