name: App Frontend - K6 Browser Tests

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    paths:
      - 'src/App/backend/**'
      - 'src/App/codelists/**'
      - 'src/App/fileanalyzers/**'
      - 'src/Runtime/localtest/**'
      - 'src/Runtime/pdf3/**'
      - 'src/App/frontend/src/**'
      - 'src/App/frontend/test/**'
      - 'src/App/frontend/yarn.lock'
      - 'src/test/apps/**'
      - '.github/workflows/app-frontend-k6-browser.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true
jobs:
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Build frontend
        uses: ./.github/actions/app-build-frontend

  build-localtest:
    name: Build Localtest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Build localtest
        uses: ./.github/actions/app-build-localtest
        with:
          docker-profile: 'test-apps'

  k6-browser:
    name: K6 Browser
    runs-on: ubuntu-latest
    needs: [build-frontend, build-localtest]
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Run Local Environment
        uses: ./.github/actions/app-run-local-env
        with:
          run-frontend: true
          run-localtest: true
          docker-profile: 'test-apps'

      - name: Test network connectivity
        run: |
          echo "Testing connectivity to localhost:80..."
          curl -v http://localhost:80/ || echo "Failed to connect to localhost:80"
          echo "Testing connectivity to localhost:5101..."
          curl -v http://localhost:5101/ || echo "Failed to connect to localhost:5101"
          echo "Testing DNS resolution of local.altinn.cloud..."
          nslookup local.altinn.cloud || echo "DNS lookup failed"
          echo "Testing connectivity to local.altinn.cloud..."
          curl -v http://local.altinn.cloud/ || echo "Failed to connect to local.altinn.cloud"

      - name: Check RAM usage
        run: free -h

      - name: Create screenshots directory
        run: sudo mkdir -p screenshots && sudo chmod 777 screenshots

      - name: Debug container user and permissions
        run: |
          docker run --rm --network host --privileged \
            -v ${{ github.workspace }}:/github/workspace \
            -w /github/workspace \
            --entrypoint="" \
            grafana/k6:master-with-browser \
            sh -c "whoami && id && ls -la screenshots/"

      - name: Run k6 browser test
        run: |
          docker run --rm --network host --privileged \
            -v ${{ github.workspace }}:/github/workspace \
            -w /github/workspace \
            -e K6_BROWSER_HEADLESS=true \
            -e K6_NO_USAGE_REPORT=true \
            -e K6_QUIET=true \
            -e K6_NO_THRESHOLDS=true \
            -e K6_NO_SUMMARY=true \
            grafana/k6:master-with-browser \
            run ./src/App/frontend/test/e2e/k6-browser/browser-script.ts
        timeout-minutes: 10

      - name: Fix screenshots ownership for artifact upload
        run: sudo chown -R runner:runner screenshots/ || echo "No screenshots to fix ownership"

      - name: Print working directory
        run: pwd

      - name: See local filesystem contents
        run: ls -la

      - name: See github workspace directory contents
        run: ls -la ${{ github.workspace }}

      - name: Check screenshots directory ownership
        run: ls -la | grep screenshots

      - name: List screenshots files with details
        run: find screenshots/ -type f -exec ls -la {} \; || echo "No files found in screenshots directory"

      - name: List k6-browser contents
        run: ls -la ./src/App/frontend/test/e2e/k6-browser/

      - name: Upload screenshots
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: k6-browser-screenshots
          path: screenshots
          retention-days: 30
