name: App Frontend - K6 Browser Tests

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    paths:
      - 'src/App/backend/**'
      - 'src/App/codelists/**'
      - 'src/App/fileanalyzers/**'
      - 'src/Runtime/localtest/**'
      - 'src/Runtime/pdf3/**'
      - 'src/App/frontend/src/**'
      - 'src/App/frontend/test/**'
      - 'src/App/frontend/yarn.lock'
      - 'src/test/apps/**'
      - '.github/workflows/app-frontend-k6-browser.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true
jobs:
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Build frontend
        uses: ./.github/actions/app-build-frontend

  build-localtest:
    name: Build Localtest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Build localtest
        uses: ./.github/actions/app-build-localtest
        with:
          docker-profile: 'test-apps'

  k6-browser:
    name: K6 Browser
    runs-on: ubuntu-latest
    needs: [build-frontend, build-localtest]
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Run Local Environment
        uses: ./.github/actions/app-run-local-env
        with:
          run-frontend: true
          run-localtest: true
          docker-profile: 'test-apps'

      - name: Setup k6 with browser support
        uses: grafana/setup-k6-action@ffe7d7290dfa715e48c2ccc924d068444c94bde2
        with:
          browser: true

      - name: Test network connectivity
        run: |
          echo "Testing connectivity to localhost:80..."
          curl -v http://localhost:80/ || echo "Failed to connect to localhost:80"
          echo "Testing connectivity to localhost:5101..."
          curl -v http://localhost:5101/ || echo "Failed to connect to localhost:5101"
          echo "Testing DNS resolution of local.altinn.cloud..."
          nslookup local.altinn.cloud || echo "DNS lookup failed"

      - name: Run k6 browser test
        run: |
          # Start k6 in background to inspect Chrome process
          k6 run ./src/App/frontend/test/e2e/k6-browser/browser-script.ts &
          K6_PID=$!
          
          # Wait a moment for Chrome to start
          sleep 5
          
          # Check if Chrome processes are running and their flags
          echo "=== Chrome processes ==="
          ps aux | grep -E "(chrome|chromium)" | head -5
          
          echo "=== Chrome command line flags ==="
          for pid in $(pgrep -f chrome); do
            echo "Process $pid:"
            cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ' | grep -o -- '--[^ ]*' | head -10 || echo "Could not read cmdline"
          done
          
          # Wait for k6 to complete
          wait $K6_PID
        timeout-minutes: 10
