name: Publish to CDN
on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build
    steps:
      - name: checkout
        uses: actions/checkout@v3
        with:
          path: app-frontend
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis

      - name: install node
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: install dependencies
        working-directory: app-frontend/src
        env:
          GITHUB_PACKAGES_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: yarn --immutable

      - name: run build
        working-directory: app-frontend/src/altinn-app-frontend
        run: yarn build

      - name: Checkout Altinn-CDN repository
        uses: actions/checkout@v3
        with:
          repository: 'Altinn/altinn-cdn'
          token: ${{secrets.ALTINN_CDN_TOKEN}}
          path: cdn

      - name: Run release script
        working-directory: app-frontend
        if: "!github.event.release.prerelease"
        run: bash .github/scripts/release.sh --frontend . --cdn ../cdn --commit

      - name: Run release script (pre-release)
        working-directory: app-frontend
        if: "github.event.release.prerelease"
        run: bash .github/scripts/release.sh --frontend . --cdn ../cdn --commit --pre-release

      - name: Push to CDN
        working-directory: cdn
        run: git push
