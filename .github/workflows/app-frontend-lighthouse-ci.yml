name: App Frontend - Lighthouse CI
on:
  push:
    branches:
      - 'main'
    paths:
      - '.github/workflows/app-frontend-lighthouse-ci.yml'
      - './.github/actions/**'
      - 'src/App/frontend/**'
      - 'src/Runtime/localtest/**'
      - 'src/test/apps/component-library/**'
  pull_request:
    paths:
      - '.github/workflows/app-frontend-lighthouse-ci.yml'
      - './.github/actions/**'
      - 'src/App/frontend/**'
      - 'src/Runtime/localtest/**'
      - 'src/test/apps/component-library/**'
  workflow_dispatch:
jobs:
  build-frontend:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Build frontend
        uses: ./.github/actions/app-build-frontend

  build-localtest:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
      - name: Build localtest
        uses: ./.github/actions/app-build-localtest
        with:
          docker-profile: 'test-apps'

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    needs: [build-frontend, build-localtest]
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0

      - name: Run Local Environment
        uses: ./.github/actions/app-run-local-env
        with:
          run-frontend: true
          run-localtest: true
          docker-profile: test-apps

      - name: Run Lighthouse CI
        env:
          ENV: 'CI' # Signals to src/App/frontend/lighthouserc.js that we're running in CI
          LHCI_SERVER_URL: ${{ secrets.LHCI_SERVER_URL }}
          LHCI_BUILD_TOKEN: ${{ secrets.LHCI_ALTINN_APP_BUILD_TOKEN }}
          LHCI_USERNAME: ${{ secrets.LHCI_BASIC_AUTH_USERNAME }}
          LHCI_PASSWORD: ${{ secrets.LHCI_BASIC_AUTH_PASSWORD }}
          LHCI_BUILD_CONTEXT__ANCESTOR_HASH: ${{ github.event.pull_request.base.sha || '' }}
        working-directory: src/App/frontend
        run: yarn run lhci
      - name: Compare Lighthouse results
        id: lighthouse-compare
        if: github.event_name == 'pull_request'
        continue-on-error: false
        uses: adevinta/actions-lighthouseci-compare@10b06f197bf31d8f6d66021376c79164cab167c9 # v1.1.7
        with:
          links-filepath: 'src/App/frontend/.lighthouseci/links.json'
          base-url: '${{ secrets.LHCI_SERVER_URL }}/v1'
          project-id: ${{ secrets.LHCI_ALTINN_APP_PROJECT_ID }}
          current-commit-sha: ${{ github.event.pull_request.head.sha }}
          basic-auth-username: ${{ secrets.LHCI_BASIC_AUTH_USERNAME }}
          basic-auth-password: ${{ secrets.LHCI_BASIC_AUTH_PASSWORD }}

      - name: Comment PR with Lighthouse Report
        if: github.event_name == 'pull_request' && steps.lighthouse-compare.outputs.markdown != ''
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          COMPARE_MARKDOWN: ${{ steps.lighthouse-compare.outputs.markdown }}
        with:
          script: |
            const marker = '<!-- lighthouse-ci-report -->';
            const compareMarkdown = process.env.COMPARE_MARKDOWN;

            let body = marker + '\nðŸ” **Lighthouse Report**\n\n' + compareMarkdown;

            const comments = await github.paginate(github.rest.issues.listComments, {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              body += `\n\n---\n*Edited*`;

              await github.rest.issues.updateComment({
                comment_id: existing.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body,
              });
            }

      - name: Stop localtest
        if: always()
        working-directory: src/Runtime/localtest
        run: docker compose down
