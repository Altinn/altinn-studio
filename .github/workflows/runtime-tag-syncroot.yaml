name: Runtime - Tag syncroot artifact

on:
  workflow_dispatch:
    inputs:
      ring:
        description: 'Ring to tag the artifact with'
        required: true
        type: string
      environment:
        description: 'Environment for deployment approval'
        required: true
        type: string
      short-sha:
        description: 'Short SHA of the artifact to tag'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  tag-artifact:
    name: Tag artifact for ${{ inputs.ring }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    defaults:
      run:
        working-directory: ./infra/runtime
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: az login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID_FC }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID_FC }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_FC }}

      - name: az acr login
        run: az acr login --name altinncr

      - name: flux install
        uses: fluxcd/flux2/action@6bf37f6a560fd84982d67f853162e4b3c2235edb # v2.6.4

      - name: tag artifact
        run: |
          flux tag artifact oci://altinncr.azurecr.io/studio-apps/syncroot:${{ inputs.short-sha }} --tag ${{ inputs.ring }}
