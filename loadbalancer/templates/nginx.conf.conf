load_module /etc/nginx/modules/ngx_http_perl_module.so;

worker_processes 1;

events { worker_connections 1024; }

http {


    # perl_modules perl/lib;
    # Support replacing reference to altinn js and css in app with local hosted webpack dev server
    perl_set $LOCAL_SUB_FILTER 'sub {
      my $r = shift;
      my $cookie = $r->header_in("cookie");
      my $url = $1 if ($cookie =~ /.*frontendVersion=(http.*?);/);
      if($url)
      {
        $uri = $r->unescape($url);
        return $uri;
      }
      return "https://altinncdn.no/toolkits/altinn-app-frontend/3/"
    }';

    client_max_body_size 50M;

    # Set timeout to 1 hour (helps when debugging)
    proxy_connect_timeout       3600;
    proxy_send_timeout          3600;
    proxy_read_timeout          3600;
    send_timeout                3600;

    sendfile on;

	  upstream localtest {
        server host.docker.internal:5101;
    }

    upstream app {
        server host.docker.internal:5005;
    }
    # Redirect localhost and the old altinn3local.no to the configured test domain
    server {
      listen 80;
      server_name localhost altinn3local.no;
      return 307 $scheme://${TEST_DOMAIN}:${ALTINN3LOCAL_PORT}$request_uri;
    }

    upstream receiptcomp {
        server host.docker.internal:5060;
    }

    upstream pdfservice {
        server host.docker.internal:5300;
    }

    upstream accessmanagementcomp {
        server host.docker.internal:5117;
    }

    server {
		    listen 80 default_server;
        server_name ${TEST_DOMAIN};

        proxy_redirect      off;
        proxy_set_header    Host $host;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;

    error_page 502 /502LocalTest.html;

		location = / {
        proxy_pass          http://localtest/Home/;
		}

		location / {
        #Support using Local js, when a cookie value is set
        sub_filter_once off;
        sub_filter 'https://altinncdn.no/toolkits/altinn-app-frontend/3/' $LOCAL_SUB_FILTER;
        proxy_pass          http://app/;
        error_page 502 /502App.html;
        proxy_cookie_domain altinn3local.no local.altinn.cloud;
		}

		location /Home/ {
			  proxy_pass		      http://localtest/Home/;
		}

    location /receipt/ {
			  proxy_pass		      http://receiptcomp/receipt/;
			  error_page 502 /502Receipt.html;
		}

    location /accessmanagement/ {
			  proxy_pass		      http://accessmanagementcomp/accessmanagement/;
        error_page 502 /502Accessmanagement.html;
		}

    location /storage/ {
			  proxy_pass		      http://localtest/storage/;
		}

    location /pdfservice/ {
        proxy_pass          http://pdfservice/;
    }

    location /localtestresources/ {
			  proxy_pass		      http://localtest/localtestresources/;
		}
    location /LocalPlatformStorage/ {
      proxy_pass           http://localtest/LocalPlatformStorage/;
    }
    location /502LocalTest.html {
      root /www;
    }
    location /502App.html {
      root /www;
    }
    location /502Receipt.html {
      root /www;
    }
     location /502Accessmanagement.html {
      root /www;
    }

	}
}
